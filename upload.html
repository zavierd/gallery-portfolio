<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>中环家居 - 后台管理</title>
  <style>
    :root {
      --primary: #18181b; /* Zinc 900 */
      --primary-hover: #27272a;
      --bg: #f4f4f5; /* Zinc 100 */
      --surface: #ffffff;
      --border: #e4e4e7; /* Zinc 200 */
      --text: #18181b;
      --text-secondary: #71717a; /* Zinc 500 */
      --danger: #ef4444;
      --success: #10b981;
      --radius: 6px;
      --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      min-height: 100vh;
      padding: 40px 20px;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      min-height: 600px;
      display: flex;
      flex-direction: column;
    }

    /* Header */
    .header {
      padding: 24px 32px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .header h1 {
      font-size: 18px;
      font-weight: 600;
      color: var(--text);
      letter-spacing: -0.025em;
    }

    .back-link {
      font-size: 14px;
      color: var(--text-secondary);
      text-decoration: none;
      transition: color 0.2s;
    }
    .back-link:hover { color: var(--primary); }

    /* Tabs */
    .tabs {
      display: flex;
      padding: 0 32px;
      border-bottom: 1px solid var(--border);
      background: #fafafa;
    }
    
    .tab {
      padding: 16px 4px;
      margin-right: 24px;
      border: none;
      background: none;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-secondary);
      cursor: pointer;
      position: relative;
      transition: color 0.2s;
    }
    
    .tab:hover { color: var(--text); }
    
    .tab.active {
      color: var(--primary);
    }
    
    .tab.active::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 0;
      width: 100%;
      height: 2px;
      background: var(--primary);
    }

    /* Content */
    .tab-content { display: none; padding: 32px; }
    .tab-content.active { display: block; animation: fadeIn 0.3s ease; }
    
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    /* Upload Area */
    .upload-area {
      border: 2px dashed var(--border);
      border-radius: var(--radius);
      padding: 60px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      background: #fafafa;
      margin-bottom: 24px;
    }
    
    .upload-area:hover, .upload-area.dragover {
      border-color: var(--text-secondary);
      background: var(--surface);
    }
    
    .upload-icon {
      width: 48px;
      height: 48px;
      margin-bottom: 16px;
      color: var(--text-secondary);
      fill: none;
      stroke: currentColor;
      stroke-width: 1.5;
    }
    
    .upload-text { font-size: 14px; font-weight: 500; margin-bottom: 4px; }
    .upload-hint { font-size: 12px; color: var(--text-secondary); }

    /* Forms */
    .form-group { margin-bottom: 20px; }
    
    label {
      display: block;
      margin-bottom: 8px;
      font-size: 13px;
      font-weight: 500;
      color: var(--text);
    }
    
    input[type="text"], select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 14px;
      background: var(--surface);
      color: var(--text);
      transition: border-color 0.2s;
    }
    
    input[type="text"]:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 1px var(--primary);
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 20px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: var(--radius);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn:hover:not(:disabled) { background: var(--primary-hover); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    
    .btn-danger { background: white; color: var(--danger); border: 1px solid var(--border); }
    .btn-danger:hover { background: #fef2f2; border-color: #fecaca; }
    
    .btn-success { background: white; color: var(--success); border: 1px solid var(--border); }
    .btn-success:hover { background: #ecfdf5; border-color: #a7f3d0; }
    
    .btn-small { padding: 6px 12px; font-size: 12px; height: 32px; }
    
    .btn-full { width: 100%; }

    /* Previews */
    .preview-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    
    .preview-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: var(--radius);
      overflow: hidden;
      border: 1px solid var(--border);
    }
    
    .preview-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .preview-item .remove {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 20px;
      height: 20px;
      background: rgba(0,0,0,0.6);
      color: white;
      border: none;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 14px;
    }

    /* Checkbox */
    .checkbox-group { display: flex; align-items: center; gap: 8px; }
    .checkbox-group input { width: 16px; height: 16px; accent-color: var(--primary); }
    .checkbox-group label { margin: 0; font-weight: normal; }

    /* Progress */
    .progress-container { margin-top: 16px; display: none; }
    .progress-bar { height: 4px; background: var(--border); border-radius: 2px; overflow: hidden; }
    .progress-bar .fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s; }
    .progress-text { text-align: center; margin-top: 8px; color: var(--text-secondary); font-size: 12px; }

    /* Messages */
    .message {
      padding: 12px 16px;
      border-radius: var(--radius);
      margin: 24px 0;
      font-size: 14px;
      display: none;
    }
    .message.success { background: #ecfdf5; color: #065f46; border: 1px solid #a7f3d0; }
    .message.error { background: #fef2f2; color: #991b1b; border: 1px solid #fecaca; }

    /* Gallery Grid */
    .gallery-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 20px;
      margin-top: 24px;
    }
    
    .gallery-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: var(--radius);
      overflow: hidden;
      border: 1px solid var(--border);
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .gallery-item:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); transform: translateY(-2px); }
    .gallery-item img { width: 100%; height: 100%; object-fit: cover; }
    
    .gallery-item .overlay {
      position: absolute;
      inset: 0;
      background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
      opacity: 0;
      transition: opacity 0.2s;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      padding: 12px;
    }
    
    .gallery-item:hover .overlay { opacity: 1; }
    
    .gallery-item-info { color: white; font-size: 12px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .gallery-item-cat { color: rgba(255,255,255,0.7); font-size: 11px; margin-top: 2px; }

    .gallery-item.selected {
      box-shadow: 0 0 0 3px var(--primary);
    }
    
    .gallery-item .actions {
      position: absolute;
      top: 8px;
      right: 8px;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .gallery-item:hover .actions { opacity: 1; }
    
    .gallery-item .actions button {
      width: 24px;
      height: 24px;
      border: none;
      background: rgba(255,255,255,0.9);
      color: var(--danger);
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }

    /* Filter & Batch Bar */
    .filter-bar { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin-bottom: 24px; padding-bottom: 24px; border-bottom: 1px solid var(--border); }
    .filter-bar select { width: 200px; }
    .count-badge { background: var(--bg); padding: 4px 10px; border-radius: 999px; font-size: 12px; color: var(--text-secondary); }

    .batch-actions {
      display: none;
      align-items: center;
      gap: 12px;
      background: #fafafa;
      padding: 12px 16px;
      border-radius: var(--radius);
      margin-bottom: 24px;
      border: 1px solid var(--border);
    }
    .batch-actions.show { display: flex; }
    .batch-actions span { font-size: 13px; font-weight: 500; color: var(--text); margin-right: 8px; }

    /* Category Tree */
    .category-tree { margin: 20px 0; border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; }
    .category-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: white;
      border-bottom: 1px solid var(--border);
    }
    .category-item:last-child { border-bottom: none; }
    .category-item.child { padding-left: 40px; background: #fafafa; }
    .category-item.grandchild { padding-left: 70px; background: #fafafa; }
    
    .category-item input {
      flex: 1;
      border: 1px solid transparent;
      background: transparent;
      padding: 4px 8px;
      font-size: 14px;
    }
    .category-item input:focus { background: white; border-color: var(--primary); }
    
    .cat-actions { display: flex; gap: 8px; opacity: 0.5; transition: opacity 0.2s; }
    .category-item:hover .cat-actions { opacity: 1; }
    
    .cat-btn {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 4px;
      border: 1px solid var(--border);
      background: white;
      cursor: pointer;
      color: var(--text-secondary);
    }
    .cat-btn:hover { border-color: var(--primary); color: var(--primary); }
    .cat-btn.delete:hover { border-color: var(--danger); color: var(--danger); }

    /* Modal */
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
    .modal.show { display: flex; }
    .modal img { max-width: 90vw; max-height: 90vh; border-radius: 4px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
    .modal .close { position: absolute; top: 24px; right: 24px; color: white; font-size: 32px; cursor: pointer; opacity: 0.7; }
    .modal .close:hover { opacity: 1; }

    @media (max-width: 600px) {
      body { padding: 0; background: white; }
      .container { border: none; box-shadow: none; border-radius: 0; min-height: 100vh; }
      .header, .tabs, .tab-content { padding-left: 20px; padding-right: 20px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>后台管理</h1>
      <a href="/" class="back-link">查看相册 &rarr;</a>
    </div>
    
    <div class="tabs">
      <button class="tab active" onclick="switchTab('upload')">上传图片</button>
      <button class="tab" onclick="switchTab('manage')">图片管理</button>
      <button class="tab" onclick="switchTab('category')">分类设置</button>
    </div>
    
    <!-- Upload Tab -->
    <div id="uploadTab" class="tab-content active">
      <div class="upload-area" id="uploadArea">
        <svg class="upload-icon" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="17 8 12 3 7 8"></polyline>
          <line x1="12" y1="3" x2="12" y2="15"></line>
        </svg>
        <div class="upload-text">点击或拖拽图片到此处</div>
        <div class="upload-hint">支持 JPG, PNG, WebP (最大 10MB)</div>
      </div>
      <input type="file" id="fileInput" multiple accept="image/*" style="display: none;">
      
      <div class="preview-container" id="previewContainer"></div>
      
      <div style="max-width: 400px; margin: 0 auto;">
        <div class="form-group">
          <label>选择分类</label>
          <select id="category"></select>
        </div>
        
        <div class="form-group">
          <div class="checkbox-group">
            <input type="checkbox" id="compressImage" checked>
            <label for="compressImage">启用智能压缩</label>
          </div>
        </div>
        
        <button class="btn btn-full" id="uploadBtn" disabled>开始上传</button>
        
        <div class="progress-container" id="progressContainer">
          <div class="progress-bar"><div class="fill" id="progressFill"></div></div>
          <div class="progress-text" id="progressText">准备就绪</div>
        </div>
        
        <div class="message" id="uploadMessage"></div>
      </div>
    </div>
    
    <!-- Manage Tab -->
    <div id="manageTab" class="tab-content">
      <div class="filter-bar">
        <select id="categoryFilter" onchange="loadGallery()"></select>
        <div class="count-badge" id="imageCount">0 项</div>
        <div style="flex:1"></div>
        <button class="btn btn-small" onclick="optimizePreviews()" id="optimizeBtn" style="background:#10b981;color:#fff;">优化预览图</button>
        <button class="btn btn-small" onclick="selectAll()" id="selectAllBtn">全选</button>
        <button class="btn btn-small" onclick="loadGallery()">刷新列表</button>
      </div>
      
      <div class="batch-actions" id="batchActions">
        <span id="selectedCount">已选择 0 项</span>
        <select id="moveToCategory" style="width: 150px; padding: 6px;"></select>
        <button class="btn btn-small btn-success" onclick="moveSelected()">移动</button>
        <button class="btn btn-small btn-danger" onclick="deleteSelected()">删除</button>
        <button class="btn btn-small" style="background:transparent; color:var(--text); border:1px solid var(--border)" onclick="clearSelection()">取消</button>
      </div>
      
      <div class="gallery-grid" id="galleryGrid"></div>
      <div class="message" id="manageMessage"></div>
    </div>
    
    <!-- Category Tab -->
    <div id="categoryTab" class="tab-content">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="font-size: 16px; font-weight: 600;">分类结构</h2>
        <button class="btn btn-small" onclick="addRootCategory()">+ 新建一级分类</button>
      </div>
      
      <div class="category-tree" id="categoryTree"></div>
      
      <div style="margin-top: 24px; text-align: right;">
        <button class="btn" onclick="saveCategories()">保存更改</button>
      </div>
      
      <div class="message" id="categoryMessage"></div>
    </div>
  </div>
  
  <div class="modal" id="imageModal" onclick="closeModal()">
    <span class="close">&times;</span>
    <img id="modalImage" src="" onclick="event.stopPropagation()">
  </div>

  <script>
    let selectedFiles = [];
    let galleryImages = [];
    let selectedImages = new Set();
    let categories = [];
    let categoryIdCounter = 1;

    // 初始化
    async function init() {
      await loadCategoriesFromServer();
      renderCategoryTree();
      updateCategorySelects();
    }
    init();

    // 从服务器加载分类
    async function loadCategoriesFromServer() {
      try {
        const res = await fetch('/api/categories');
        const data = await res.json();
        categories = data.categories || [];
        categoryIdCounter = getMaxId(categories) + 1;
      } catch (e) {
        categories = [
          { id: '1', name: '默认分类', children: [] }
        ];
      }
    }

    // 获取最大ID
    function getMaxId(cats, max = 0) {
      for (const cat of cats) {
        const id = parseInt(cat.id) || 0;
        if (id > max) max = id;
        if (cat.children?.length) max = getMaxId(cat.children, max);
      }
      return max;
    }

    // 保存分类到服务器
    async function saveCategories() {
      // 更新分类名称
      updateCategoryNames();
      
      try {
        const res = await fetch('/api/categories', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ categories })
        });
        
        if (res.ok) {
          showCategoryMessage('设置已保存', 'success');
          updateCategorySelects();
        } else {
          showCategoryMessage('保存失败', 'error');
        }
      } catch (e) {
        showCategoryMessage('保存失败: ' + e.message, 'error');
      }
    }

    // 从输入框更新分类名称
    function updateCategoryNames() {
      document.querySelectorAll('.category-item input').forEach(input => {
        const id = input.dataset.id;
        const cat = findCategoryById(categories, id);
        if (cat) cat.name = input.value;
      });
    }

    // 查找分类
    function findCategoryById(cats, id) {
      for (const cat of cats) {
        if (cat.id === id) return cat;
        if (cat.children?.length) {
          const found = findCategoryById(cat.children, id);
          if (found) return found;
        }
      }
      return null;
    }

    // 添加根分类
    function addRootCategory() {
      categories.push({ id: String(categoryIdCounter++), name: '新分类', children: [] });
      renderCategoryTree();
    }

    // 添加子分类
    function addChildCategory(parentId) {
      const parent = findCategoryById(categories, parentId);
      if (parent) {
        if (!parent.children) parent.children = [];
        parent.children.push({ id: String(categoryIdCounter++), name: '子分类', children: [] });
        renderCategoryTree();
      }
    }

    // 删除分类
    function deleteCategory(id) {
      if (!confirm('确定删除此分类吗？')) return;
      deleteCategoryFromList(categories, id);
      renderCategoryTree();
    }

    function deleteCategoryFromList(cats, id) {
      for (let i = 0; i < cats.length; i++) {
        if (cats[i].id === id) {
          cats.splice(i, 1);
          return true;
        }
        if (cats[i].children?.length && deleteCategoryFromList(cats[i].children, id)) {
          return true;
        }
      }
      return false;
    }

    // 渲染分类树
    function renderCategoryTree() {
      const tree = document.getElementById('categoryTree');
      if (categories.length === 0) {
        tree.innerHTML = '<div style="padding:20px;text-align:center;color:#999">暂无分类</div>';
        return;
      }
      tree.innerHTML = renderCategoryItems(categories, 0);
    }

    function renderCategoryItems(cats, level) {
      const levelClass = level === 0 ? '' : level === 1 ? 'child' : 'grandchild';
      return cats.map(cat => `
        <div class="category-item ${levelClass}">
          <input type="text" value="${cat.name}" data-id="${cat.id}" placeholder="分类名称">
          <div class="cat-actions">
            <button class="cat-btn" onclick="addChildCategory('${cat.id}')">添加子分类</button>
            <button class="cat-btn delete" onclick="deleteCategory('${cat.id}')">删除</button>
          </div>
        </div>
        ${cat.children?.length ? renderCategoryItems(cat.children, level + 1) : ''}
      `).join('');
    }

    // 更新分类下拉框
    function updateCategorySelects() {
      const options = getFlatCategories(categories);
      const optionsHtml = options.map(c => `<option value="${c.path}">${c.display}</option>`).join('');
      
      const catSelect = document.getElementById('category');
      const filterSelect = document.getElementById('categoryFilter');
      const moveSelect = document.getElementById('moveToCategory');
      
      if(catSelect) catSelect.innerHTML = optionsHtml;
      if(filterSelect) filterSelect.innerHTML = '<option value="">所有分类</option>' + optionsHtml;
      if(moveSelect) moveSelect.innerHTML = '<option value="">选择分类...</option>' + optionsHtml;
    }

    // 扁平化分类（带层级显示）
    function getFlatCategories(cats, prefix = '', level = 0) {
      let result = [];
      for (const cat of cats) {
        const path = prefix ? `${prefix}/${cat.name}` : cat.name;
        const indent = '\u00A0\u00A0'.repeat(level); // Use non-breaking spaces
        result.push({ path: cat.name, display: indent + cat.name });
        if (cat.children?.length) {
          result = result.concat(getFlatCategories(cat.children, path, level + 1));
        }
      }
      return result;
    }

    function showCategoryMessage(text, type) {
      const msg = document.getElementById('categoryMessage');
      msg.textContent = text;
      msg.className = `message ${type}`;
      msg.style.display = 'block';
      setTimeout(() => msg.style.display = 'none', 3000);
    }

    // 切换标签页
    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      
      const tabIndex = { upload: 1, manage: 2, category: 3 }[tab];
      document.querySelector(`.tab:nth-child(${tabIndex})`).classList.add('active');
      document.getElementById(tab + 'Tab').classList.add('active');
      
      if (tab === 'manage') loadGallery();
      if (tab === 'category') renderCategoryTree();
    }

    // 加载图片库
    async function loadGallery() {
      const grid = document.getElementById('galleryGrid');
      grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:#999;padding:40px;">加载中...</div>';
      
      try {
        const res = await fetch('/api/gallery');
        const data = await res.json();
        const filter = document.getElementById('categoryFilter').value;
        
        galleryImages = [];
        for (const [cat, info] of Object.entries(data.gallery || {})) {
          if (!filter || filter === cat) {
            for (const img of info.images) {
              galleryImages.push({ ...img, category: cat });
            }
          }
        }
        
        document.getElementById('imageCount').textContent = `${galleryImages.length} 项`;
        
        if (galleryImages.length === 0) {
          grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:#999;padding:40px;">暂无图片</div>';
          return;
        }
        
        grid.innerHTML = galleryImages.map((img, idx) => `
          <div class="gallery-item ${selectedImages.has(img.original) ? 'selected' : ''}" 
               onclick="toggleSelect('${img.original}')" 
               ondblclick="viewImage('${img.original}')">
            <img src="${img.preview || img.original}" loading="lazy">
            <div class="overlay">
               <div class="gallery-item-info">${img.name}</div>
               <div class="gallery-item-cat">${img.category}</div>
            </div>
            <div class="actions">
              <button class="delete-btn" onclick="event.stopPropagation();deleteImage('${img.category}/${img.name}')">×</button>
            </div>
          </div>
        `).join('');
      } catch (e) {
        grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:#ef4444;padding:40px;">加载数据失败</div>';
      }
    }

    function toggleSelect(url) {
      if (selectedImages.has(url)) selectedImages.delete(url);
      else selectedImages.add(url);
      updateSelection();
    }

    function updateSelection() {
      document.querySelectorAll('.gallery-item').forEach((item, idx) => {
        const url = galleryImages[idx]?.original;
        item.classList.toggle('selected', selectedImages.has(url));
      });
      const count = selectedImages.size;
      document.getElementById('selectedCount').textContent = `已选择 ${count} 项`;
      document.getElementById('batchActions').classList.toggle('show', count > 0);
      updateSelectAllBtn();
    }

    function clearSelection() { selectedImages.clear(); updateSelection(); updateSelectAllBtn(); }
    
    function selectAll() {
      if (selectedImages.size === galleryImages.length) {
        // 如果已全选，则取消全选
        selectedImages.clear();
      } else {
        // 全选所有图片
        galleryImages.forEach(img => selectedImages.add(img.original));
      }
      updateSelection();
      updateSelectAllBtn();
    }
    
    function updateSelectAllBtn() {
      const btn = document.getElementById('selectAllBtn');
      if (selectedImages.size === galleryImages.length && galleryImages.length > 0) {
        btn.textContent = '取消全选';
      } else {
        btn.textContent = '全选';
      }
    }
    function viewImage(url) { document.getElementById('modalImage').src = url; document.getElementById('imageModal').classList.add('show'); }
    function closeModal() { document.getElementById('imageModal').classList.remove('show'); }

    async function deleteImage(key) {
      if (!confirm('确定永久删除这张图片吗？')) return;
      const parts = key.split('/');
      const category = parts[0];
      const fileName = parts[1];
      const ext = galleryImages.find(img => img.name === fileName)?.original.split('.').pop() || 'jpg';
      const fullKey = `${category}/${fileName}.${ext}`;
      
      try {
        const res = await fetch('/api/delete', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ key: fullKey }) });
        if (res.ok) { showManageMessage('删除成功', 'success'); loadGallery(); }
        else showManageMessage('删除失败', 'error');
      } catch (e) { showManageMessage('删除失败: ' + e.message, 'error'); }
    }

    async function deleteSelected() {
      if (!confirm(`确定永久删除这 ${selectedImages.size} 张图片吗？`)) return;
      let success = 0, failed = 0;
      for (const url of selectedImages) {
        const img = galleryImages.find(i => i.original === url);
        if (!img) continue;
        const ext = url.split('.').pop();
        const key = `${img.category}/${img.name}.${ext}`;
        try {
          const res = await fetch('/api/delete', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ key }) });
          if (res.ok) success++; else failed++;
        } catch (e) { failed++; }
      }
      selectedImages.clear();
      showManageMessage(`完成：成功 ${success} 张，失败 ${failed} 张`, failed ? 'error' : 'success');
      loadGallery();
    }

    async function moveSelected() {
      const targetCategory = document.getElementById('moveToCategory').value;
      if (!targetCategory) {
        showManageMessage('请选择目标分类', 'error');
        return;
      }
      if (selectedImages.size === 0) {
        showManageMessage('未选择图片', 'error');
        return;
      }

      let success = 0, failed = 0;
      for (const url of selectedImages) {
        const img = galleryImages.find(i => i.original === url);
        if (!img) continue;
        if (img.category === targetCategory) continue;
        
        const ext = url.split('.').pop();
        const sourceKey = `${img.category}/${img.name}.${ext}`;
        
        try {
          const res = await fetch('/api/move', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ sourceKey, targetCategory })
          });
          if (res.ok) success++;
          else failed++;
        } catch (e) {
          failed++;
        }
      }
      
      selectedImages.clear();
      showManageMessage(`移动完成：成功 ${success} 张，失败 ${failed} 张`, failed ? 'error' : 'success');
      loadGallery();
    }

    function showManageMessage(text, type, duration = 3000) {
      const msg = document.getElementById('manageMessage');
      msg.textContent = text;
      msg.className = `message ${type}`;
      msg.style.display = 'block';
      if (duration > 0) setTimeout(() => msg.style.display = 'none', duration);
    }

    // 批量优化预览图
    async function optimizePreviews() {
      const btn = document.getElementById('optimizeBtn');
      btn.disabled = true;
      btn.textContent = '检查中...';
      
      // 先获取未压缩的图片列表
      let needProcess = [];
      try {
        const res = await fetch('/api/check-sizes');
        const data = await res.json();
        if (data.notCompressed === 0) {
          btn.disabled = false;
          btn.textContent = '优化预览图';
          showManageMessage('所有图片已优化，无需处理', 'success');
          return;
        }
        // 获取未压缩图片的 key 列表
        needProcess = data.samples.map(s => s.original);
        // 如果未压缩数量大于 samples，需要获取完整列表
        if (data.notCompressed > data.samples.length) {
          // 从 galleryImages 中筛选
          const sampleSet = new Set(data.samples.map(s => s.original));
          needProcess = galleryImages.filter(img => {
            const ext = img.original.split('.').pop();
            const key = `${img.category}/${img.name}.${ext}`;
            return sampleSet.has(key) || data.notCompressed > 10;
          });
        } else {
          // 转换为 galleryImages 格式
          needProcess = data.samples.map(s => {
            const parts = s.original.split('/');
            const category = parts[0];
            const fileName = parts.slice(1).join('/');
            const name = fileName.substring(0, fileName.lastIndexOf('.'));
            return galleryImages.find(img => img.category === category && img.name === name);
          }).filter(Boolean);
        }
        
        if (needProcess.length === 0) {
          btn.disabled = false;
          btn.textContent = '优化预览图';
          showManageMessage('所有图片已优化，无需处理', 'success');
          return;
        }
        
        if (!confirm(`发现 ${data.notCompressed} 张图片需要优化预览图，是否开始处理？`)) {
          btn.disabled = false;
          btn.textContent = '优化预览图';
          return;
        }
      } catch (e) {
        console.error('检查失败:', e);
        if (!confirm('无法检查状态，是否处理所有图片？')) {
          btn.disabled = false;
          btn.textContent = '优化预览图';
          return;
        }
        needProcess = galleryImages;
      }
      
      btn.textContent = '处理中...';
      let success = 0, failed = 0, skipped = 0, total = needProcess.length;
      
      for (let i = 0; i < needProcess.length; i++) {
        const img = needProcess[i];
        if (!img) { skipped++; continue; }
        showManageMessage(`优化中: ${i + 1}/${total} (成功${success}/失败${failed})`, 'success', 0);
        
        try {
          // 通过代理加载原图
          const ext = img.original.split('.').pop();
          const imageKey = `${img.category}/${img.name}.${ext}`;
          const controller = new AbortController();
          const timeout = setTimeout(() => controller.abort(), 30000);
          const response = await fetch(`/api/proxy-image?key=${encodeURIComponent(imageKey)}`, { signal: controller.signal });
          clearTimeout(timeout);
          if (!response.ok) throw new Error('图片加载失败');
          const blob = await response.blob();
          
          // 生成压缩预览图
          const previewBlob = await new Promise((resolve, reject) => {
            const timer = setTimeout(() => reject(new Error('图片处理超时')), 15000);
            const imgEl = new Image();
            imgEl.onload = () => {
              clearTimeout(timer);
              const canvas = document.createElement('canvas');
              let w = imgEl.width, h = imgEl.height;
              const maxSize = 400;
              if (w > maxSize || h > maxSize) {
                if (w > h) { h = (h / w) * maxSize; w = maxSize; }
                else { w = (w / h) * maxSize; h = maxSize; }
              }
              canvas.width = w; canvas.height = h;
              canvas.getContext('2d').drawImage(imgEl, 0, 0, w, h);
              canvas.toBlob(b => b ? resolve(b) : reject(new Error('toBlob失败')), 'image/webp', 0.6);
              URL.revokeObjectURL(imgEl.src);
            };
            imgEl.onerror = () => { clearTimeout(timer); reject(new Error('图片加载失败')); };
            imgEl.src = URL.createObjectURL(blob);
          });
          
          // 上传预览图
          const formData = new FormData();
          formData.append('preview', new File([previewBlob], img.name + '.webp', { type: 'image/webp' }));
          formData.append('category', img.category);
          formData.append('baseName', img.name);
          
          const res = await fetch('/api/upload-preview', { method: 'POST', body: formData });
          if (res.ok) success++; else failed++;
        } catch (e) {
          console.error('处理失败:', img.name, e);
          failed++;
        }
      }
      
      btn.disabled = false;
      btn.textContent = '优化预览图';
      showManageMessage(`优化完成：成功 ${success} 张，失败 ${failed} 张`, failed ? 'error' : 'success');
    }

    // 上传功能
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const previewContainer = document.getElementById('previewContainer');
    const uploadBtn = document.getElementById('uploadBtn');

    uploadArea.addEventListener('click', () => fileInput.click());
    uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
    uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
    uploadArea.addEventListener('drop', (e) => { e.preventDefault(); uploadArea.classList.remove('dragover'); handleFiles(e.dataTransfer.files); });
    fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

    function handleFiles(files) {
      for (const file of files) {
        if (file.type.startsWith('image/')) { selectedFiles.push(file); addPreview(file); }
      }
      updateUploadBtn();
    }

    function addPreview(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        const div = document.createElement('div');
        div.className = 'preview-item';
        div.innerHTML = `<img src="${e.target.result}"><button class="remove" onclick="removeFile('${file.name}')">×</button>`;
        previewContainer.appendChild(div);
      };
      reader.readAsDataURL(file);
    }

    window.removeFile = function(name) {
      selectedFiles = selectedFiles.filter(f => f.name !== name);
      previewContainer.innerHTML = '';
      selectedFiles.forEach(f => addPreview(f));
      updateUploadBtn();
    };

    function updateUploadBtn() {
      uploadBtn.disabled = selectedFiles.length === 0;
      uploadBtn.textContent = selectedFiles.length > 0 ? `上传 ${selectedFiles.length} 张图片` : '开始上传';
    }

    // 压缩原图（最大2000px，质量80%）
    async function compressImage(file, maxSize = 2000, quality = 0.8) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            let w = img.width, h = img.height;
            if (w > maxSize || h > maxSize) {
              if (w > h) { h = (h / w) * maxSize; w = maxSize; }
              else { w = (w / h) * maxSize; h = maxSize; }
            }
            canvas.width = w; canvas.height = h;
            canvas.getContext('2d').drawImage(img, 0, 0, w, h);
            canvas.toBlob(blob => resolve(new File([blob], file.name, { type: 'image/jpeg' })), 'image/jpeg', quality);
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    // 生成预览图（最大400px，WebP格式，质量60%）
    async function generatePreview(file) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            let w = img.width, h = img.height;
            const maxSize = 400;
            if (w > maxSize || h > maxSize) {
              if (w > h) { h = (h / w) * maxSize; w = maxSize; }
              else { w = (w / h) * maxSize; h = maxSize; }
            }
            canvas.width = w; canvas.height = h;
            canvas.getContext('2d').drawImage(img, 0, 0, w, h);
            const baseName = file.name.substring(0, file.name.lastIndexOf('.')) || file.name;
            canvas.toBlob(blob => resolve(new File([blob], baseName + '.webp', { type: 'image/webp' })), 'image/webp', 0.6);
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    uploadBtn.addEventListener('click', async () => {
      const category = document.getElementById('category').value;
      if (!category || selectedFiles.length === 0) return;

      uploadBtn.disabled = true;
      document.getElementById('progressContainer').style.display = 'block';
      
      const shouldCompress = document.getElementById('compressImage').checked;
      let uploaded = 0, failed = 0;

      for (let i = 0; i < selectedFiles.length; i++) {
        let file = selectedFiles[i];
        document.getElementById('progressText').textContent = `处理中 ${i + 1}/${selectedFiles.length}`;
        document.getElementById('progressFill').style.width = `${(i / selectedFiles.length) * 100}%`;
        
        // 压缩原图
        if (shouldCompress) { 
          try { file = await compressImage(file); } catch (e) { console.error('压缩失败:', e); } 
        }
        
        // 生成小预览图
        let previewFile = null;
        try { 
          previewFile = await generatePreview(file); 
        } catch (e) { 
          console.error('生成预览图失败:', e); 
        }
        
        try {
          const formData = new FormData();
          formData.append('file', file);
          formData.append('category', category);
          if (previewFile) formData.append('preview', previewFile);
          const res = await fetch('/api/upload', { method: 'POST', body: formData });
          if (res.ok) uploaded++; else failed++;
        } catch (e) { failed++; }
      }

      document.getElementById('progressFill').style.width = '100%';
      document.getElementById('progressText').textContent = '完成!';
      
      const msg = document.getElementById('uploadMessage');
      msg.textContent = `上传完成：成功 ${uploaded} 张，失败 ${failed} 张`;
      msg.className = `message ${failed ? 'error' : 'success'}`;
      msg.style.display = 'block';
      
      selectedFiles = [];
      previewContainer.innerHTML = '';
      updateUploadBtn();
      setTimeout(() => {
         uploadBtn.disabled = false;
         document.getElementById('progressContainer').style.display = 'none';
      }, 2000);
    });

    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });
  </script>
</body>
</html>
