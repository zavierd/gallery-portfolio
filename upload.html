<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å›¾ç‰‡ä¸Šä¼ </title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 30px;
      font-size: 24px;
    }
    .upload-area {
      border: 3px dashed #ddd;
      border-radius: 12px;
      padding: 60px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      margin-bottom: 20px;
    }
    .upload-area:hover, .upload-area.dragover {
      border-color: #667eea;
      background: #f8f9ff;
    }
    .upload-area p { color: #666; font-size: 16px; }
    .upload-area .icon { font-size: 48px; margin-bottom: 10px; }
    
    .form-group {
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }
    input, select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .preview-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }
    .preview-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: 8px;
      overflow: hidden;
    }
    .preview-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .preview-item .remove {
      position: absolute;
      top: 4px;
      right: 4px;
      background: rgba(255,0,0,0.8);
      color: white;
      border: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 14px;
    }
    .preview-item .name {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 4px;
      font-size: 10px;
      text-overflow: ellipsis;
      overflow: hidden;
      white-space: nowrap;
    }
    
    .btn {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .progress-container {
      margin-top: 20px;
      display: none;
    }
    .progress-bar {
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      overflow: hidden;
    }
    .progress-bar .fill {
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      width: 0%;
      transition: width 0.3s;
    }
    .progress-text {
      text-align: center;
      margin-top: 10px;
      color: #666;
      font-size: 14px;
    }
    
    .message {
      padding: 12px;
      border-radius: 8px;
      margin-top: 20px;
      display: none;
    }
    .message.success {
      background: #d4edda;
      color: #155724;
    }
    .message.error {
      background: #f8d7da;
      color: #721c24;
    }
    
    .back-link {
      display: block;
      text-align: center;
      margin-top: 20px;
      color: #667eea;
      text-decoration: none;
    }
    .back-link:hover {
      text-decoration: underline;
    }
    
    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .checkbox-group input {
      width: auto;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“· å›¾ç‰‡ä¸Šä¼ </h1>
    
    <div class="upload-area" id="uploadArea">
      <div class="icon">ğŸ“</div>
      <p>ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„</p>
      <p style="font-size: 12px; color: #999; margin-top: 8px;">æ”¯æŒ JPGã€PNGã€GIFã€WebP æ ¼å¼</p>
    </div>
    <input type="file" id="fileInput" multiple accept="image/*" style="display: none;">
    
    <div class="preview-container" id="previewContainer"></div>
    
    <div class="form-group">
      <label>åˆ†ç±»åç§°</label>
      <input type="text" id="category" placeholder="è¾“å…¥åˆ†ç±»åç§°ï¼Œå¦‚ï¼šé£æ™¯ã€äººåƒã€è¡—æ‹" list="categoryList">
      <datalist id="categoryList"></datalist>
    </div>
    
    <div class="form-group">
      <div class="checkbox-group">
        <input type="checkbox" id="generatePreview" checked>
        <label for="generatePreview" style="margin: 0;">ç”Ÿæˆé¢„è§ˆå›¾ï¼ˆæ¨èï¼‰</label>
      </div>
    </div>
    
    <div class="form-group">
      <div class="checkbox-group">
        <input type="checkbox" id="compressImage" checked>
        <label for="compressImage" style="margin: 0;">ä¸Šä¼ å‰å‹ç¼©å›¾ç‰‡ï¼ˆåŠ å¿«ä¸Šä¼ é€Ÿåº¦ï¼‰</label>
      </div>
      <select id="compressQuality" style="margin-top: 8px; width: auto;">
        <option value="0.9">é«˜è´¨é‡ (90%)</option>
        <option value="0.8" selected>ä¸­ç­‰è´¨é‡ (80%)</option>
        <option value="0.6">è¾ƒä½è´¨é‡ (60%)</option>
      </select>
    </div>
    
    <button class="btn" id="uploadBtn" disabled>ä¸Šä¼ å›¾ç‰‡</button>
    
    <div class="progress-container" id="progressContainer">
      <div class="progress-bar"><div class="fill" id="progressFill"></div></div>
      <div class="progress-text" id="progressText">å‡†å¤‡ä¸Šä¼ ...</div>
    </div>
    
    <div class="message" id="message"></div>
    
    <a href="/" class="back-link">â† è¿”å›ç›¸å†Œ</a>
  </div>

  <script>
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const previewContainer = document.getElementById('previewContainer');
    const categoryInput = document.getElementById('category');
    const uploadBtn = document.getElementById('uploadBtn');
    const progressContainer = document.getElementById('progressContainer');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const message = document.getElementById('message');
    const categoryList = document.getElementById('categoryList');

    let selectedFiles = [];

    // åŠ è½½ç°æœ‰åˆ†ç±»
    async function loadCategories() {
      try {
        const res = await fetch('/gallery-index.json');
        const data = await res.json();
        const categories = Object.keys(data.gallery || {});
        categoryList.innerHTML = categories.map(c => `<option value="${c}">`).join('');
      } catch (e) {
        console.log('æ— æ³•åŠ è½½åˆ†ç±»åˆ—è¡¨');
      }
    }
    loadCategories();

    // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸ
    uploadArea.addEventListener('click', () => fileInput.click());

    // æ‹–æ‹½å¤„ç†
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });
    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      handleFiles(e.dataTransfer.files);
    });

    // æ–‡ä»¶é€‰æ‹©
    fileInput.addEventListener('change', (e) => {
      handleFiles(e.target.files);
    });

    // å¤„ç†æ–‡ä»¶
    function handleFiles(files) {
      for (const file of files) {
        if (file.type.startsWith('image/')) {
          selectedFiles.push(file);
          addPreview(file);
        }
      }
      updateUploadBtn();
    }

    // æ·»åŠ é¢„è§ˆ
    function addPreview(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        const div = document.createElement('div');
        div.className = 'preview-item';
        div.innerHTML = `
          <img src="${e.target.result}">
          <button class="remove" onclick="removeFile('${file.name}')">Ã—</button>
          <div class="name">${file.name}</div>
        `;
        previewContainer.appendChild(div);
      };
      reader.readAsDataURL(file);
    }

    // ç§»é™¤æ–‡ä»¶
    window.removeFile = function(name) {
      selectedFiles = selectedFiles.filter(f => f.name !== name);
      previewContainer.innerHTML = '';
      selectedFiles.forEach(f => addPreview(f));
      updateUploadBtn();
    };

    // æ›´æ–°ä¸Šä¼ æŒ‰é’®çŠ¶æ€
    function updateUploadBtn() {
      uploadBtn.disabled = selectedFiles.length === 0;
      uploadBtn.textContent = selectedFiles.length > 0 
        ? `ä¸Šä¼  ${selectedFiles.length} å¼ å›¾ç‰‡` 
        : 'ä¸Šä¼ å›¾ç‰‡';
    }

    // æ˜¾ç¤ºæ¶ˆæ¯
    function showMessage(text, type) {
      message.textContent = text;
      message.className = `message ${type}`;
      message.style.display = 'block';
    }

    // å‹ç¼©å›¾ç‰‡
    async function compressImage(file, quality) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;
            
            // é™åˆ¶æœ€å¤§å°ºå¯¸ä¸º 2000px
            const maxSize = 2000;
            if (width > maxSize || height > maxSize) {
              if (width > height) {
                height = (height / width) * maxSize;
                width = maxSize;
              } else {
                width = (width / height) * maxSize;
                height = maxSize;
              }
            }
            
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            
            canvas.toBlob((blob) => {
              resolve(new File([blob], file.name, { type: 'image/jpeg' }));
            }, 'image/jpeg', quality);
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    // ä¸Šä¼ 
    uploadBtn.addEventListener('click', async () => {
      const category = categoryInput.value.trim();
      if (!category) {
        showMessage('è¯·è¾“å…¥åˆ†ç±»åç§°', 'error');
        return;
      }
      if (selectedFiles.length === 0) {
        showMessage('è¯·é€‰æ‹©å›¾ç‰‡', 'error');
        return;
      }

      uploadBtn.disabled = true;
      progressContainer.style.display = 'block';
      message.style.display = 'none';

      const generatePreview = document.getElementById('generatePreview').checked;
      const shouldCompress = document.getElementById('compressImage').checked;
      const compressQuality = parseFloat(document.getElementById('compressQuality').value);
      let uploaded = 0;
      let failed = 0;

      for (let i = 0; i < selectedFiles.length; i++) {
        let file = selectedFiles[i];
        
        // å‹ç¼©å›¾ç‰‡
        if (shouldCompress && file.type.startsWith('image/')) {
          progressText.textContent = `æ­£åœ¨å‹ç¼© ${i + 1}/${selectedFiles.length}: ${file.name}`;
          try {
            const originalSize = file.size;
            file = await compressImage(file, compressQuality);
            console.log(`å‹ç¼©: ${(originalSize/1024).toFixed(0)}KB -> ${(file.size/1024).toFixed(0)}KB`);
          } catch (e) {
            console.warn('å‹ç¼©å¤±è´¥ï¼Œä½¿ç”¨åŸå›¾:', e);
          }
        }
        
        progressText.textContent = `æ­£åœ¨ä¸Šä¼  ${i + 1}/${selectedFiles.length}: ${file.name}`;
        progressFill.style.width = `${(i / selectedFiles.length) * 100}%`;

        try {
          const formData = new FormData();
          formData.append('file', file);
          formData.append('category', category);
          formData.append('generatePreview', generatePreview);

          const res = await fetch('/api/upload', {
            method: 'POST',
            body: formData
          });

          if (res.ok) {
            uploaded++;
          } else {
            const err = await res.json();
            console.error(`ä¸Šä¼ å¤±è´¥: ${file.name}`, err);
            failed++;
          }
        } catch (e) {
          console.error(`ä¸Šä¼ å¤±è´¥: ${file.name}`, e);
          failed++;
        }
      }

      progressFill.style.width = '100%';
      progressText.textContent = 'ä¸Šä¼ å®Œæˆï¼';

      if (failed === 0) {
        showMessage(`æˆåŠŸä¸Šä¼  ${uploaded} å¼ å›¾ç‰‡ï¼åˆ·æ–°é¦–é¡µå³å¯æŸ¥çœ‹ã€‚`, 'success');
        selectedFiles = [];
        previewContainer.innerHTML = '';
        updateUploadBtn();
      } else {
        showMessage(`ä¸Šä¼ å®Œæˆï¼šæˆåŠŸ ${uploaded} å¼ ï¼Œå¤±è´¥ ${failed} å¼ `, failed > 0 ? 'error' : 'success');
      }

      uploadBtn.disabled = false;
    });
  </script>
</body>
</html>
