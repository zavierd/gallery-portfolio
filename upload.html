<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å›¾ç‰‡ç®¡ç†</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    h1, h2 {
      color: #333;
      margin-bottom: 20px;
    }
    h1 { text-align: center; font-size: 24px; }
    h2 { font-size: 18px; border-bottom: 2px solid #667eea; padding-bottom: 10px; margin-top: 30px; }
    
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    .tab {
      padding: 10px 20px;
      border: none;
      background: #e0e0e0;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
    }
    .tab.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    .upload-area {
      border: 3px dashed #ddd;
      border-radius: 12px;
      padding: 40px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      margin-bottom: 20px;
    }
    .upload-area:hover, .upload-area.dragover {
      border-color: #667eea;
      background: #f8f9ff;
    }
    .upload-area .icon { font-size: 48px; margin-bottom: 10px; }
    
    .form-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
    input, select {
      width: 100%;
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
    }
    input:focus, select:focus { outline: none; border-color: #667eea; }
    
    .preview-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 10px;
      margin-bottom: 20px;
    }
    .preview-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: 8px;
      overflow: hidden;
    }
    .preview-item img { width: 100%; height: 100%; object-fit: cover; }
    .preview-item .remove {
      position: absolute;
      top: 4px;
      right: 4px;
      background: rgba(255,0,0,0.8);
      color: white;
      border: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 12px;
    }
    
    .btn {
      padding: 12px 24px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .btn:hover:not(:disabled) { transform: translateY(-2px); }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .btn-danger { background: linear-gradient(135deg, #e53935 0%, #c62828 100%); }
    .btn-small { padding: 6px 12px; font-size: 12px; }
    
    .checkbox-group { display: flex; align-items: center; gap: 8px; }
    .checkbox-group input { width: auto; }
    .checkbox-group label { margin: 0; }
    
    .progress-container { margin-top: 15px; display: none; }
    .progress-bar { height: 6px; background: #e0e0e0; border-radius: 3px; overflow: hidden; }
    .progress-bar .fill { height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); width: 0%; transition: width 0.3s; }
    .progress-text { text-align: center; margin-top: 8px; color: #666; font-size: 13px; }
    
    .message { padding: 12px; border-radius: 8px; margin: 15px 0; display: none; }
    .message.success { background: #d4edda; color: #155724; display: block; }
    .message.error { background: #f8d7da; color: #721c24; display: block; }
    
    .gallery-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    .gallery-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      cursor: pointer;
      transition: transform 0.2s;
    }
    .gallery-item:hover { transform: scale(1.02); }
    .gallery-item img { width: 100%; height: 100%; object-fit: cover; }
    .gallery-item .overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(transparent, rgba(0,0,0,0.8));
      color: white;
      padding: 30px 8px 8px;
      font-size: 11px;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .gallery-item:hover .overlay { opacity: 1; }
    .gallery-item .actions {
      position: absolute;
      top: 8px;
      right: 8px;
      display: flex;
      gap: 5px;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .gallery-item:hover .actions { opacity: 1; }
    .gallery-item .actions button {
      width: 28px;
      height: 28px;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .gallery-item .actions .delete-btn { background: rgba(255,0,0,0.9); color: white; }
    .gallery-item.selected { outline: 3px solid #667eea; }
    
    .filter-bar {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 15px;
    }
    .filter-bar select { width: auto; min-width: 150px; }
    .filter-bar .count { color: #666; font-size: 14px; }
    
    .batch-actions {
      display: none;
      gap: 10px;
      margin-bottom: 15px;
      padding: 10px;
      background: #f5f5f5;
      border-radius: 8px;
      align-items: center;
    }
    .batch-actions.show { display: flex; }
    
    .back-link {
      display: block;
      text-align: center;
      margin-top: 20px;
      color: #667eea;
      text-decoration: none;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal.show { display: flex; }
    .modal img {
      max-width: 90%;
      max-height: 90%;
      border-radius: 8px;
    }
    .modal .close {
      position: absolute;
      top: 20px;
      right: 20px;
      color: white;
      font-size: 30px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“· å›¾ç‰‡ç®¡ç†</h1>
    
    <div class="tabs">
      <button class="tab active" onclick="switchTab('upload')">ä¸Šä¼ å›¾ç‰‡</button>
      <button class="tab" onclick="switchTab('manage')">ç®¡ç†å›¾ç‰‡</button>
    </div>
    
    <!-- ä¸Šä¼ æ ‡ç­¾é¡µ -->
    <div id="uploadTab" class="tab-content active">
      <div class="upload-area" id="uploadArea">
        <div class="icon">ğŸ“</div>
        <p>ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„</p>
        <p style="font-size: 12px; color: #999; margin-top: 8px;">æ”¯æŒ JPGã€PNGã€GIFã€WebP æ ¼å¼</p>
      </div>
      <input type="file" id="fileInput" multiple accept="image/*" style="display: none;">
      
      <div class="preview-container" id="previewContainer"></div>
      
      <div class="form-group">
        <label>åˆ†ç±»åç§°</label>
        <input type="text" id="category" placeholder="è¾“å…¥åˆ†ç±»åç§°" list="categoryList">
        <datalist id="categoryList"></datalist>
      </div>
      
      <div class="form-group">
        <div class="checkbox-group">
          <input type="checkbox" id="compressImage" checked>
          <label for="compressImage">ä¸Šä¼ å‰å‹ç¼©å›¾ç‰‡</label>
        </div>
      </div>
      
      <button class="btn" id="uploadBtn" disabled style="width: 100%;">ä¸Šä¼ å›¾ç‰‡</button>
      
      <div class="progress-container" id="progressContainer">
        <div class="progress-bar"><div class="fill" id="progressFill"></div></div>
        <div class="progress-text" id="progressText">å‡†å¤‡ä¸Šä¼ ...</div>
      </div>
      
      <div class="message" id="uploadMessage"></div>
    </div>
    
    <!-- ç®¡ç†æ ‡ç­¾é¡µ -->
    <div id="manageTab" class="tab-content">
      <div class="filter-bar">
        <select id="categoryFilter" onchange="loadGallery()">
          <option value="">æ‰€æœ‰åˆ†ç±»</option>
        </select>
        <span class="count" id="imageCount">0 å¼ å›¾ç‰‡</span>
        <button class="btn btn-small" onclick="loadGallery()">åˆ·æ–°</button>
      </div>
      
      <div class="batch-actions" id="batchActions">
        <span id="selectedCount">å·²é€‰æ‹© 0 å¼ </span>
        <button class="btn btn-small btn-danger" onclick="deleteSelected()">åˆ é™¤é€‰ä¸­</button>
        <button class="btn btn-small" onclick="clearSelection()">å–æ¶ˆé€‰æ‹©</button>
      </div>
      
      <div class="gallery-grid" id="galleryGrid"></div>
      
      <div class="message" id="manageMessage"></div>
    </div>
    
    <a href="/" class="back-link">â† è¿”å›ç›¸å†Œ</a>
  </div>
  
  <!-- å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡† -->
  <div class="modal" id="imageModal" onclick="closeModal()">
    <span class="close">&times;</span>
    <img id="modalImage" src="" onclick="event.stopPropagation()">
  </div>

  <script>
    let selectedFiles = [];
    let galleryImages = [];
    let selectedImages = new Set();

    // åˆ‡æ¢æ ‡ç­¾é¡µ
    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.querySelector(`.tab:nth-child(${tab === 'upload' ? 1 : 2})`).classList.add('active');
      document.getElementById(tab + 'Tab').classList.add('active');
      
      if (tab === 'manage') loadGallery();
    }

    // åŠ è½½åˆ†ç±»åˆ—è¡¨
    async function loadCategories() {
      try {
        const res = await fetch('/api/gallery');
        const data = await res.json();
        const categories = Object.keys(data.gallery || {});
        
        document.getElementById('categoryList').innerHTML = categories.map(c => `<option value="${c}">`).join('');
        document.getElementById('categoryFilter').innerHTML = '<option value="">æ‰€æœ‰åˆ†ç±»</option>' + 
          categories.map(c => `<option value="${c}">${c}</option>`).join('');
      } catch (e) {
        console.log('åŠ è½½åˆ†ç±»å¤±è´¥');
      }
    }
    loadCategories();

    // åŠ è½½å›¾ç‰‡åº“
    async function loadGallery() {
      const grid = document.getElementById('galleryGrid');
      grid.innerHTML = '<p style="text-align:center;color:#666;">åŠ è½½ä¸­...</p>';
      
      try {
        const res = await fetch('/api/gallery');
        const data = await res.json();
        const filter = document.getElementById('categoryFilter').value;
        
        galleryImages = [];
        for (const [cat, info] of Object.entries(data.gallery || {})) {
          if (!filter || filter === cat) {
            for (const img of info.images) {
              galleryImages.push({ ...img, category: cat });
            }
          }
        }
        
        document.getElementById('imageCount').textContent = `${galleryImages.length} å¼ å›¾ç‰‡`;
        
        if (galleryImages.length === 0) {
          grid.innerHTML = '<p style="text-align:center;color:#666;">æš‚æ— å›¾ç‰‡</p>';
          return;
        }
        
        grid.innerHTML = galleryImages.map((img, idx) => `
          <div class="gallery-item ${selectedImages.has(img.original) ? 'selected' : ''}" 
               onclick="toggleSelect('${img.original}')" 
               ondblclick="viewImage('${img.original}')">
            <img src="${img.preview || img.original}" loading="lazy">
            <div class="overlay">${img.name}<br>${img.category}</div>
            <div class="actions">
              <button class="delete-btn" onclick="event.stopPropagation();deleteImage('${img.category}/${img.name}')">Ã—</button>
            </div>
          </div>
        `).join('');
        
      } catch (e) {
        grid.innerHTML = '<p style="text-align:center;color:#c00;">åŠ è½½å¤±è´¥</p>';
      }
    }

    // é€‰æ‹©/å–æ¶ˆé€‰æ‹©å›¾ç‰‡
    function toggleSelect(url) {
      if (selectedImages.has(url)) {
        selectedImages.delete(url);
      } else {
        selectedImages.add(url);
      }
      updateSelection();
    }

    // æ›´æ–°é€‰æ‹©çŠ¶æ€
    function updateSelection() {
      document.querySelectorAll('.gallery-item').forEach((item, idx) => {
        const url = galleryImages[idx]?.original;
        item.classList.toggle('selected', selectedImages.has(url));
      });
      
      const count = selectedImages.size;
      document.getElementById('selectedCount').textContent = `å·²é€‰æ‹© ${count} å¼ `;
      document.getElementById('batchActions').classList.toggle('show', count > 0);
    }

    // æ¸…é™¤é€‰æ‹©
    function clearSelection() {
      selectedImages.clear();
      updateSelection();
    }

    // æŸ¥çœ‹å¤§å›¾
    function viewImage(url) {
      document.getElementById('modalImage').src = url;
      document.getElementById('imageModal').classList.add('show');
    }

    // å…³é—­æ¨¡æ€æ¡†
    function closeModal() {
      document.getElementById('imageModal').classList.remove('show');
    }

    // åˆ é™¤å•å¼ å›¾ç‰‡
    async function deleteImage(key) {
      if (!confirm('ç¡®å®šåˆ é™¤è¿™å¼ å›¾ç‰‡å—ï¼Ÿ')) return;
      
      // ä» URL ä¸­æå–æ­£ç¡®çš„ key
      const parts = key.split('/');
      const category = parts[0];
      const fileName = parts[1];
      const ext = galleryImages.find(img => img.name === fileName)?.original.split('.').pop() || 'jpg';
      const fullKey = `${category}/${fileName}.${ext}`;
      
      try {
        const res = await fetch('/api/delete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ key: fullKey })
        });
        
        if (res.ok) {
          showManageMessage('åˆ é™¤æˆåŠŸ', 'success');
          loadGallery();
        } else {
          showManageMessage('åˆ é™¤å¤±è´¥', 'error');
        }
      } catch (e) {
        showManageMessage('åˆ é™¤å¤±è´¥: ' + e.message, 'error');
      }
    }

    // æ‰¹é‡åˆ é™¤
    async function deleteSelected() {
      if (!confirm(`ç¡®å®šåˆ é™¤é€‰ä¸­çš„ ${selectedImages.size} å¼ å›¾ç‰‡å—ï¼Ÿ`)) return;
      
      let success = 0, failed = 0;
      
      for (const url of selectedImages) {
        const img = galleryImages.find(i => i.original === url);
        if (!img) continue;
        
        const ext = url.split('.').pop();
        const key = `${img.category}/${img.name}.${ext}`;
        
        try {
          const res = await fetch('/api/delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ key })
          });
          if (res.ok) success++;
          else failed++;
        } catch (e) {
          failed++;
        }
      }
      
      selectedImages.clear();
      showManageMessage(`åˆ é™¤å®Œæˆï¼šæˆåŠŸ ${success} å¼ ${failed ? 'ï¼Œå¤±è´¥ ' + failed + ' å¼ ' : ''}`, failed ? 'error' : 'success');
      loadGallery();
    }

    function showManageMessage(text, type) {
      const msg = document.getElementById('manageMessage');
      msg.textContent = text;
      msg.className = `message ${type}`;
      setTimeout(() => msg.className = 'message', 3000);
    }

    // ========== ä¸Šä¼ åŠŸèƒ½ ==========
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const previewContainer = document.getElementById('previewContainer');
    const uploadBtn = document.getElementById('uploadBtn');

    uploadArea.addEventListener('click', () => fileInput.click());
    uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
    uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
    uploadArea.addEventListener('drop', (e) => { e.preventDefault(); uploadArea.classList.remove('dragover'); handleFiles(e.dataTransfer.files); });
    fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

    function handleFiles(files) {
      for (const file of files) {
        if (file.type.startsWith('image/')) {
          selectedFiles.push(file);
          addPreview(file);
        }
      }
      updateUploadBtn();
    }

    function addPreview(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        const div = document.createElement('div');
        div.className = 'preview-item';
        div.innerHTML = `<img src="${e.target.result}"><button class="remove" onclick="removeFile('${file.name}')">Ã—</button>`;
        previewContainer.appendChild(div);
      };
      reader.readAsDataURL(file);
    }

    window.removeFile = function(name) {
      selectedFiles = selectedFiles.filter(f => f.name !== name);
      previewContainer.innerHTML = '';
      selectedFiles.forEach(f => addPreview(f));
      updateUploadBtn();
    };

    function updateUploadBtn() {
      uploadBtn.disabled = selectedFiles.length === 0;
      uploadBtn.textContent = selectedFiles.length > 0 ? `ä¸Šä¼  ${selectedFiles.length} å¼ å›¾ç‰‡` : 'ä¸Šä¼ å›¾ç‰‡';
    }

    async function compressImage(file, quality = 0.8) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            let w = img.width, h = img.height;
            const max = 2000;
            if (w > max || h > max) {
              if (w > h) { h = (h / w) * max; w = max; }
              else { w = (w / h) * max; h = max; }
            }
            canvas.width = w; canvas.height = h;
            canvas.getContext('2d').drawImage(img, 0, 0, w, h);
            canvas.toBlob(blob => resolve(new File([blob], file.name, { type: 'image/jpeg' })), 'image/jpeg', quality);
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    uploadBtn.addEventListener('click', async () => {
      const category = document.getElementById('category').value.trim();
      if (!category) { alert('è¯·è¾“å…¥åˆ†ç±»åç§°'); return; }
      if (selectedFiles.length === 0) return;

      uploadBtn.disabled = true;
      document.getElementById('progressContainer').style.display = 'block';
      
      const shouldCompress = document.getElementById('compressImage').checked;
      let uploaded = 0, failed = 0;

      for (let i = 0; i < selectedFiles.length; i++) {
        let file = selectedFiles[i];
        document.getElementById('progressText').textContent = `ä¸Šä¼  ${i + 1}/${selectedFiles.length}`;
        document.getElementById('progressFill').style.width = `${(i / selectedFiles.length) * 100}%`;
        
        if (shouldCompress) {
          try { file = await compressImage(file); } catch (e) {}
        }
        
        try {
          const formData = new FormData();
          formData.append('file', file);
          formData.append('category', category);
          formData.append('generatePreview', 'true');
          const res = await fetch('/api/upload', { method: 'POST', body: formData });
          if (res.ok) uploaded++; else failed++;
        } catch (e) { failed++; }
      }

      document.getElementById('progressFill').style.width = '100%';
      document.getElementById('progressText').textContent = 'å®Œæˆï¼';
      
      const msg = document.getElementById('uploadMessage');
      msg.textContent = `ä¸Šä¼ å®Œæˆï¼šæˆåŠŸ ${uploaded} å¼ ${failed ? 'ï¼Œå¤±è´¥ ' + failed + ' å¼ ' : ''}`;
      msg.className = `message ${failed ? 'error' : 'success'}`;
      
      selectedFiles = [];
      previewContainer.innerHTML = '';
      updateUploadBtn();
      uploadBtn.disabled = false;
      loadCategories();
    });

    // ESC å…³é—­æ¨¡æ€æ¡†
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });
  </script>
</body>
</html>
